{"ast":null,"code":"import _regeneratorRuntime from \"C:/Users/Alias/weboldal/web-login/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"C:/Users/Alias/weboldal/web-login/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _createForOfIteratorHelper from \"C:/Users/Alias/weboldal/web-login/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nvar __defProp = Object.defineProperty;\nvar __defProps = Object.defineProperties;\nvar __getOwnPropDescs = Object.getOwnPropertyDescriptors;\nvar __getOwnPropSymbols = Object.getOwnPropertySymbols;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __propIsEnum = Object.prototype.propertyIsEnumerable;\nvar __defNormalProp = function __defNormalProp(obj, key, value) {\n  return key in obj ? __defProp(obj, key, {\n    enumerable: true,\n    configurable: true,\n    writable: true,\n    value: value\n  }) : obj[key] = value;\n};\nvar __spreadValues = function __spreadValues(a, b) {\n  for (var prop in b || (b = {})) {\n    if (__hasOwnProp.call(b, prop)) __defNormalProp(a, prop, b[prop]);\n  }\n  if (__getOwnPropSymbols) {\n    var _iterator = _createForOfIteratorHelper(__getOwnPropSymbols(b)),\n      _step;\n    try {\n      for (_iterator.s(); !(_step = _iterator.n()).done;) {\n        var prop = _step.value;\n        if (__propIsEnum.call(b, prop)) __defNormalProp(a, prop, b[prop]);\n      }\n    } catch (err) {\n      _iterator.e(err);\n    } finally {\n      _iterator.f();\n    }\n  }\n  return a;\n};\nvar __spreadProps = function __spreadProps(a, b) {\n  return __defProps(a, __getOwnPropDescs(b));\n};\nimport { InMemoryCache, createHttpLink, split, from, ApolloClient } from \"@apollo/client/core\";\nimport { setContext } from \"@apollo/client/link/context\";\nimport { GraphQLWsLink } from \"@apollo/client/link/subscriptions\";\nimport { getMainDefinition } from \"@apollo/client/utilities\";\nimport { createClient } from \"graphql-ws\";\nfunction createRestartableClient(options) {\n  var restartRequested = false;\n  var _restart = function restart() {\n    restartRequested = true;\n  };\n  var _started = false;\n  var started = function started() {\n    return _started;\n  };\n  var client = createClient(__spreadProps(__spreadValues({}, options), {\n    on: __spreadProps(__spreadValues({}, options.on), {\n      connected: function connected() {\n        _started = true;\n      },\n      opened: function opened(originalSocket) {\n        var _a, _b;\n        var socket = originalSocket;\n        (_b = (_a = options.on) == null ? void 0 : _a.opened) == null ? void 0 : _b.call(_a, socket);\n        _restart = function restart() {\n          if (socket.readyState === WebSocket.OPEN) {\n            socket.close(4205, \"Client Restart\");\n          } else {\n            restartRequested = true;\n          }\n        };\n        if (restartRequested) {\n          restartRequested = false;\n          _restart();\n        }\n      }\n    })\n  }));\n  return __spreadProps(__spreadValues({}, client), {\n    restart: function restart() {\n      return _restart();\n    },\n    started: started\n  });\n}\nvar isBrowser = typeof window !== \"undefined\";\nvar createApolloClient = function createApolloClient(_ref) {\n  var nhost = _ref.nhost,\n    graphqlUrl = _ref.graphqlUrl,\n    _ref$headers = _ref.headers,\n    headers = _ref$headers === void 0 ? {} : _ref$headers,\n    _ref$publicRole = _ref.publicRole,\n    publicRole = _ref$publicRole === void 0 ? \"public\" : _ref$publicRole,\n    fetchPolicy = _ref.fetchPolicy,\n    _ref$cache = _ref.cache,\n    cache = _ref$cache === void 0 ? new InMemoryCache() : _ref$cache,\n    _ref$connectToDevTool = _ref.connectToDevTools,\n    connectToDevTools = _ref$connectToDevTool === void 0 ? isBrowser && false : _ref$connectToDevTool,\n    onError = _ref.onError;\n  var backendUrl = graphqlUrl || (nhost == null ? void 0 : nhost.graphql.getUrl());\n  if (!backendUrl) {\n    throw Error(\"Can't initialize the Apollo Client: no backend Url has been provided\");\n  }\n  var interpreter = nhost == null ? void 0 : nhost.auth.client.interpreter;\n  var token = null;\n  var getAuthHeaders = function getAuthHeaders() {\n    var resHeaders = __spreadProps(__spreadValues({}, headers), {\n      \"Sec-WebSocket-Protocol\": \"graphql-ws\"\n    });\n    if (token) {\n      resHeaders.authorization = \"Bearer \".concat(token);\n    } else {\n      resHeaders.role = publicRole;\n    }\n    return resHeaders;\n  };\n  var uri = backendUrl;\n  var wsClient = isBrowser && createRestartableClient({\n    url: uri.startsWith(\"https\") ? uri.replace(/^https/, \"wss\") : uri.replace(/^http/, \"ws\"),\n    connectionParams: function connectionParams() {\n      return {\n        headers: __spreadValues(__spreadValues({}, headers), getAuthHeaders())\n      };\n    }\n  });\n  var wsLink = wsClient && new GraphQLWsLink(wsClient);\n  var httpLink = setContext(function (_, _ref2) {\n    var headers2 = _ref2.headers;\n    return {\n      headers: __spreadValues(__spreadValues({}, headers2), getAuthHeaders())\n    };\n  }).concat(createHttpLink({\n    uri: uri\n  }));\n  var link = wsLink ? split(function (_ref3) {\n    var query = _ref3.query;\n    var mainDefinition = getMainDefinition(query);\n    var kind = mainDefinition.kind;\n    var operation;\n    if (\"operation\" in mainDefinition) {\n      operation = mainDefinition.operation;\n    }\n    return kind === \"OperationDefinition\" && operation === \"subscription\";\n  }, wsLink, httpLink) : httpLink;\n  var apolloClientOptions = {\n    cache: cache || new InMemoryCache(),\n    ssrMode: !isBrowser,\n    defaultOptions: {\n      watchQuery: {\n        fetchPolicy: fetchPolicy\n      }\n    },\n    connectToDevTools: connectToDevTools\n  };\n  apolloClientOptions.link = typeof onError === \"function\" ? from([onError, link]) : from([link]);\n  var client = new ApolloClient(apolloClientOptions);\n  interpreter == null ? void 0 : interpreter.onTransition( /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(state, event) {\n      var newToken;\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (![\"SIGNOUT\", \"SIGNED_IN\", \"TOKEN_CHANGED\"].includes(event.type)) {\n                _context.next = 16;\n                break;\n              }\n              newToken = state.context.accessToken.value;\n              token = newToken;\n              if (!(event.type === \"SIGNOUT\")) {\n                _context.next = 15;\n                break;\n              }\n              _context.prev = 4;\n              _context.next = 7;\n              return client.resetStore();\n            case 7:\n              _context.next = 13;\n              break;\n            case 9:\n              _context.prev = 9;\n              _context.t0 = _context[\"catch\"](4);\n              console.error(\"Error resetting Apollo client cache\");\n              console.error(_context.t0);\n            case 13:\n              _context.next = 16;\n              break;\n            case 15:\n              if (isBrowser && wsClient && wsClient.started()) {\n                wsClient.restart();\n              }\n            case 16:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[4, 9]]);\n    }));\n    return function (_x, _x2) {\n      return _ref4.apply(this, arguments);\n    };\n  }());\n  return client;\n};\nexport { createApolloClient };","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQO,iCAAiCA,SAA2C;EACjF,IAAIC,mBAAmB;EACvB,IAAIC,WAAU,mBAAM;IACCD;EAAA;EAErB,IAAIE,WAAW;EACf,IAAMC,UAAU,SAAVA;IAAA,OAAgBD;EAAA;EAEtB,IAAME,SAASC,aAAaC,iCACvBP,UADuB;IAE1BQ,IAAID,iCACCP,QAAQQ,KADT;MAEFC,WAAW,qBAAM;QACJN;MACb;MACAO,QAAQ,gBAACC,gBAAmB;;QAC1B,IAAMC,SAASD;QACP,8CAAID,WAAJ,4BAAaE;QAErBV,WAAU,mBAAM;UACV,WAAOW,eAAeC,UAAUC,MAAM;YAEjCH,aAAM,MAAM,gBAAgB;UAAA,OAC9B;YAGcX;UACrB;QAAA;QAIF,IAAIA,kBAAkB;UACDA;UACXC;QACV;MACF;IACF;EAAA,EACD;EAEM,wCACFG,SADE;IAELH,SAAS;MAAA,OAAMA,UAAQ;IAAA;IACvBE;EAAA;AAEJ;ACpCA,IAAMY,YAAY,OAAOC,WAAW;AAa7B,IAAMC,qBAAqB,SAArBA,yBASsC;EAAA,IARjDC;IACAC;IAAA,oBACAC;IAAAA,oCAAU,CAAC;IAAA,uBACXC;IAAAA,0CAAa;IACbC;IAAA,kBACAC;IAAAA,gCAAQ,IAAIC,eAAc;IAAA,6BAC1BC;IAAAA,uDAAoBV,aAAa;IACjCW;EAEA,IAAIC,aAAaR,eAAcD,+BAAOU,QAAQC;EAC9C,IAAI,CAACF,YAAY;IACf,MAAMG,MAAM,sEAAsE;EACpF;EACM,kBAAcZ,+BAAOa,KAAK3B,OAAO4B;EAEvC,IAAIC,QAAuB;EAE3B,IAAMC,iBAAiB,SAAjBA,iBAAuB;IAE3B,IAAMC,aAAa7B,iCACdc,UADc;MAEjB,0BAA0B;IAAA;IAK5B,IAAIa,OAAO;MACTE,WAAWC,iCAA0BH;IAAA,OAChC;MAELE,WAAWE,OAAOhB;IACpB;IAEO;EAAA;EAGT,IAAMiB,MAAMX;EAEN,eACJZ,aACAwB,wBAAwB;IACtBC,KAAKF,IAAIG,WAAW,OAAO,IAAIH,IAAII,QAAQ,UAAU,KAAK,IAAIJ,IAAII,QAAQ,SAAS,IAAI;IACvFC,kBAAkB;MAAA,OAAO;QACvBvB,SAASwB,kCACJxB,UACAc,gBAAe;MACpB;IAAA;EACF,CACD;EACH,IAAMW,SAASC,YAAY,IAAIC,cAAcD,QAAQ;EAErD,IAAME,WAAWC,WAAW,UAACC,UAAmB;IAAA,qBAAd9B;IACzB;MACLA,SAASwB,kCACJO,WACAjB,gBAAe;IACpB;EACF,CACD,EAAEkB,OACDC,eAAe;IACbf;EACD,EACH;EAEA,IAAMgB,OAAOT,SACTU,MACE,iBAAe;IAAA,IAAZC;IACK,qBAAiBC,kBAAkBD,KAAK;IAE9C,IAAQE,OAASC,eAATD;IACJ;IACJ,IAAI,eAAeC,gBAAgB;MACjCC,YAAYD,eAAeC;IAC7B;IAEO,gBAAS,yBAAyBA,cAAc;EAAA,GAEzDf,QACAG,QACF,IACAA;EAEJ,IAAMa,sBAAgD;IACpDtC,OAAOA,SAAS,IAAIC,eAAc;IAClCsC,SAAS,CAAC/C;IACVgD,gBAAgB;MACdC,YAAY;QACV1C;MACF;IACF;IACAG;EAAA;EAIFoC,oBAAoBP,OAAO,OAAO5B,YAAY,aAAauC,KAAK,CAACvC,SAAS4B,IAAI,CAAC,IAAIW,KAAK,CAACX,IAAI,CAAC;EAExF,aAAS,IAAIY,aAAaL,mBAAmB;EAEtC7B;IAAA,uEAAa,iBAAOmC,OAAOC;MAAA;MAAA;QAAA;UAAA;YAAA;cAAA,KAClC,CAAC,WAAW,aAAa,eAAe,EAAEC,SAASD,MAAME,IAAI;gBAAA;gBAAA;cAAA;cACzDC,WAAWJ,MAAMK,QAAQC,YAAYC;cACnCzC;cAAA,MACJmC,MAAME,SAAS;gBAAA;gBAAA;cAAA;cAAA;cAAA;cAAA,OAETlE,OAAOuE;YAAA;cAAA;cAAA;YAAA;cAAA;cAAA;cAEbC,QAAQC,MAAM,qCAAqC;cACnDD,QAAQC,kBAAW;YAAA;cAAA;cAAA;YAAA;cAGrB,IAAI9D,aAAa+B,YAAYA,SAAS3C,WAAW;gBAC/C2C,SAAS7C,SAAQ;cACnB;YAAA;YAAA;cAAA;UAAA;QAAA;MAAA;IAAA,CAEJ;IAAA;MAAA;IAAA;EAAA;EAGK;AACT","names":["options","restartRequested","restart","_started","started","client","createClient","__spreadProps","on","connected","opened","originalSocket","socket","readyState","WebSocket","OPEN","isBrowser","window","createApolloClient","nhost","graphqlUrl","headers","publicRole","fetchPolicy","cache","InMemoryCache","connectToDevTools","onError","backendUrl","graphql","getUrl","Error","auth","interpreter","token","getAuthHeaders","resHeaders","authorization","role","uri","createRestartableClient","url","startsWith","replace","connectionParams","__spreadValues","wsLink","wsClient","GraphQLWsLink","httpLink","setContext","_","headers2","concat","createHttpLink","link","split","query","getMainDefinition","kind","mainDefinition","operation","apolloClientOptions","ssrMode","defaultOptions","watchQuery","from","ApolloClient","state","event","includes","type","newToken","context","accessToken","value","resetStore","console","error"],"sources":["C:\\Users\\Alias\\weboldal\\web-login\\node_modules\\@nhost\\apollo\\src\\ws.ts","C:\\Users\\Alias\\weboldal\\web-login\\node_modules\\@nhost\\apollo\\src\\index.ts"],"sourcesContent":["// * See https://github.com/enisdenjo/graphql-ws#graceful-restart\nimport { Client, ClientOptions, createClient } from 'graphql-ws'\n\nexport interface RestartableClient extends Client {\n  restart(): void\n  started(): boolean\n}\n\nexport function createRestartableClient(options: ClientOptions): RestartableClient {\n  let restartRequested = false\n  let restart = () => {\n    restartRequested = true\n  }\n  let _started = false\n  const started = () => _started\n\n  const client = createClient({\n    ...options,\n    on: {\n      ...options.on,\n      connected: () => {\n        _started = true\n      },\n      opened: (originalSocket) => {\n        const socket = originalSocket as WebSocket\n        options.on?.opened?.(socket)\n\n        restart = () => {\n          if (socket.readyState === WebSocket.OPEN) {\n            // if the socket is still open for the restart, do the restart\n            socket.close(4205, 'Client Restart')\n          } else {\n            // otherwise the socket might've closed, indicate that you want\n            // a restart on the next opened event\n            restartRequested = true\n          }\n        }\n\n        // just in case you were eager to restart\n        if (restartRequested) {\n          restartRequested = false\n          restart()\n        }\n      }\n    }\n  })\n\n  return {\n    ...client,\n    restart: () => restart(),\n    started\n  }\n}\n","import {\n  ApolloClient,\n  ApolloClientOptions,\n  createHttpLink,\n  from,\n  InMemoryCache,\n  RequestHandler,\n  split,\n  WatchQueryFetchPolicy\n} from '@apollo/client/core'\nimport { setContext } from '@apollo/client/link/context'\nimport { GraphQLWsLink } from '@apollo/client/link/subscriptions'\nimport { getMainDefinition } from '@apollo/client/utilities'\nimport { NhostClient } from '@nhost/nhost-js'\n\nimport { createRestartableClient } from './ws'\nconst isBrowser = typeof window !== 'undefined'\n\nexport type NhostApolloClientOptions = {\n  nhost?: NhostClient\n  graphqlUrl?: string\n  headers?: any\n  publicRole?: string\n  fetchPolicy?: WatchQueryFetchPolicy\n  connectToDevTools?: boolean\n  cache?: InMemoryCache\n  onError?: RequestHandler\n}\n\nexport const createApolloClient = ({\n  nhost,\n  graphqlUrl,\n  headers = {},\n  publicRole = 'public',\n  fetchPolicy,\n  cache = new InMemoryCache(),\n  connectToDevTools = isBrowser && process.env.NODE_ENV === 'development',\n  onError\n}: NhostApolloClientOptions): ApolloClient<any> => {\n  let backendUrl = graphqlUrl || nhost?.graphql.getUrl()\n  if (!backendUrl) {\n    throw Error(\"Can't initialize the Apollo Client: no backend Url has been provided\")\n  }\n  const interpreter = nhost?.auth.client.interpreter\n\n  let token: string | null = null\n\n  const getAuthHeaders = () => {\n    // add headers\n    const resHeaders = {\n      ...headers,\n      'Sec-WebSocket-Protocol': 'graphql-ws'\n    }\n\n    // add auth headers if signed in\n    // or add 'public' role if not signed in\n    if (token) {\n      resHeaders.authorization = `Bearer ${token}`\n    } else {\n      // ? Not sure it changes anything for Hasura\n      resHeaders.role = publicRole\n    }\n\n    return resHeaders\n  }\n\n  const uri = backendUrl\n\n  const wsClient =\n    isBrowser &&\n    createRestartableClient({\n      url: uri.startsWith('https') ? uri.replace(/^https/, 'wss') : uri.replace(/^http/, 'ws'),\n      connectionParams: () => ({\n        headers: {\n          ...headers,\n          ...getAuthHeaders()\n        }\n      })\n    })\n  const wsLink = wsClient && new GraphQLWsLink(wsClient)\n\n  const httpLink = setContext((_, { headers }) => {\n    return {\n      headers: {\n        ...headers,\n        ...getAuthHeaders()\n      }\n    }\n  }).concat(\n    createHttpLink({\n      uri\n    })\n  )\n\n  const link = wsLink\n    ? split(\n        ({ query }) => {\n          const mainDefinition = getMainDefinition(query)\n\n          const { kind } = mainDefinition\n          let operation\n          if ('operation' in mainDefinition) {\n            operation = mainDefinition.operation\n          }\n\n          return kind === 'OperationDefinition' && operation === 'subscription'\n        },\n        wsLink,\n        httpLink\n      )\n    : httpLink\n\n  const apolloClientOptions: ApolloClientOptions<any> = {\n    cache: cache || new InMemoryCache(),\n    ssrMode: !isBrowser,\n    defaultOptions: {\n      watchQuery: {\n        fetchPolicy\n      }\n    },\n    connectToDevTools\n  }\n\n  // add link\n  apolloClientOptions.link = typeof onError === 'function' ? from([onError, link]) : from([link])\n\n  const client = new ApolloClient(apolloClientOptions)\n\n  interpreter?.onTransition(async (state, event) => {\n    if (['SIGNOUT', 'SIGNED_IN', 'TOKEN_CHANGED'].includes(event.type)) {\n      const newToken = state.context.accessToken.value\n      token = newToken\n      if (event.type === 'SIGNOUT') {\n        try {\n          await client.resetStore()\n        } catch (error) {\n          console.error('Error resetting Apollo client cache')\n          console.error(error)\n        }\n      } else {\n        if (isBrowser && wsClient && wsClient.started()) {\n          wsClient.restart()\n        }\n      }\n    }\n  })\n\n  return client\n}\n"]},"metadata":{},"sourceType":"module"}